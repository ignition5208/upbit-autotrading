<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Traders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h3>Traders</h3>
    <div>
      <a class="btn btn-outline-secondary" href="/">Home</a>
      <a class="btn btn-outline-secondary" href="/accounts.html">Accounts</a>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-header">Add Trader</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-2"><input id="trader_id" class="form-control" placeholder="trader_id (e.g. test-01)"></div>
        <div class="col-md-2"><input id="display_name" class="form-control" placeholder="display_name"></div>
        <div class="col-md-2">
          <select id="mode" class="form-select">
            <option>PAPER</option>
            <option>LIVE</option>
          </select>
        </div>
        <div class="col-md-2">
          <select id="strategy_mode" class="form-select">
            <option>SAFE</option>
            <option selected>STANDARD</option>
            <option>PROFIT</option>
            <option>CRAZY</option>
          </select>
        </div>
        <div class="col-md-2">
          <select id="account_id" class="form-select"></select>
        </div>
        <div class="col-md-1"><input id="krw_alloc_limit" class="form-control" placeholder="KRW limit" value="0"></div>
        <div class="col-md-1 d-grid">
          <button class="btn btn-primary" onclick="addTrader()">Add</button>
        </div>
      </div>
      <div id="msg" class="small text-danger mt-2"></div>
    </div>
  </div>

  <h5 class="mt-4">List</h5>
  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th>Trader</th><th>Mode</th><th>Strategy</th><th>Account</th><th>Enabled</th><th>Paused</th><th>Trade</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script src="/app.js"></script>
<script>
async function loadAccounts(){
  const items = await apiGet("/accounts");
  const s = document.getElementById("account_id");
  s.innerHTML = `<option value="">(none)</option>` + items.map(a => `<option value="${a.id}">${a.name} (#${a.id})</option>`).join("");
}
async function loadTraders(){
  const items = await apiGet("/traders");
  const tb = document.getElementById("tbody");
  tb.innerHTML = items.map(t => `
    <tr>
      <td><a href="/trader_detail.html?trader_id=${encodeURIComponent(t.trader_id)}">${t.trader_id}</a></td>
      <td>${t.mode}</td>
      <td>${t.strategy_mode}</td>
      <td>${t.account_id ?? ""}</td>
      <td>${t.is_enabled ? "Y" : "N"}</td>
      <td>${t.is_paused ? "Y" : "N"}</td>
      <td>${t.trade_enabled ? "Y" : "N"}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="openApply('${t.trader_id}', '${t.mode}', '${t.strategy_mode}')">Apply</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteTrader('${t.trader_id}', false)">Deactivate</button>
        <button class="btn btn-sm btn-danger" onclick="deleteTrader('${t.trader_id}', true)">Hard</button>
      </td>
    </tr>
  `).join("");
}

async function addTrader(){
  document.getElementById("msg").textContent="";
  try{
    const accountId = document.getElementById("account_id").value;
    await apiPost("/traders", {
      trader_id: document.getElementById("trader_id").value,
      display_name: document.getElementById("display_name").value || null,
      mode: document.getElementById("mode").value,
      strategy_mode: document.getElementById("strategy_mode").value,
      account_id: accountId ? parseInt(accountId) : null,
      krw_alloc_limit: parseInt(document.getElementById("krw_alloc_limit").value || "0")
    });
    await loadTraders();
  }catch(e){
    document.getElementById("msg").textContent = e.message;
  }
}

async function deleteTrader(trader_id, hard){
  const msg = hard
    ? `HARD DELETE ${trader_id}\n- container(if exists) removed\n- DB(trader/config/orders/trades/positions/scores) removed\nProceed?`
    : `Deactivate ${trader_id}\n- container(if exists) removed\n- DB keeps history (disabled/paused/trade_off)\nProceed?`;
  if(!confirm(msg)) return;
  await apiDelete(`/traders/${encodeURIComponent(trader_id)}?hard=${hard ? "true" : "false"}`);
  await loadTraders();
}

async function openApply(trader_id, mode, strategy_mode){
  let trade_enabled = 0;
  if(mode === "LIVE"){
    const enable = confirm("LIVE mode: Trading ON? (OK=enable trading, Cancel=apply only)");
    trade_enabled = enable ? 1 : 0;

    if(strategy_mode === "CRAZY" && enable){
      const crazy = confirm("CRAZY + LIVE: 2nd confirm required. OK=confirm, Cancel=abort");
      if(!crazy) return;
      await apiPost(`/config/${encodeURIComponent(trader_id)}/apply`, {apply_mode:"restart", trade_enabled, confirm_crazy_live:true});
      await loadTraders();
      return;
    }
  }
  await apiPost(`/config/${encodeURIComponent(trader_id)}/apply`, {apply_mode:"restart", trade_enabled});
  await loadTraders();
}

loadAccounts().then(loadTraders);
</script>
</body>
</html>
