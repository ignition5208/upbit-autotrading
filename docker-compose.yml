services:
  mariadb:
    image: mariadb:11
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./infra/mariadb/init:/docker-entrypoint-initdb.d:ro
      - ./infra/mariadb/conf/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    healthcheck:
      test: ["CMD","mariadb-admin","ping","-h","127.0.0.1","-uroot","-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 30

  dashboard-api:
    build: ./dashboard-api
    environment:
      DATABASE_URL: ${DATABASE_URL}
      API_KEY: ${API_KEY}
      TRADER_COMPOSE_PROJECT_DIR: /workspace
      TRADER_SERVICE_TEMPLATE: trader-template
    depends_on:
      mariadb:
        condition: service_healthy
    volumes:
      - ./:/workspace
    ports:
      - "8000:8000"

  dashboard-web:
    build: ./dashboard-web
    depends_on:
      - dashboard-api
    # NOTE: 사용자의 web은 이미 존재한다고 했으므로 여기서는 스켈레톤만 유지
    ports:
      - "8080:80"

  trainer:
    build: ./trainer
    environment:
      DATABASE_URL: ${DATABASE_URL}
    depends_on:
      mariadb:
        condition: service_healthy

  # trader는 초기 0개. UI에서 동적 생성.
  # trader-template:
  #   build: ./trader
  #   environment:
  #     DATABASE_URL: ${DATABASE_URL}
  #     UPBIT_ACCESS_KEY: ${UPBIT_ACCESS_KEY}
  #     UPBIT_SECRET_KEY: ${UPBIT_SECRET_KEY}
  #     TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
  #     TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
  #   depends_on:
  #     mariadb:
  #       condition: service_healthy

volumes:
  mariadb_data:
    name: upbit_mariadb_data
